<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Choose Your Adventure</title>
<style>
    *{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;font-family:'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;user-select:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body{background:#0a0e17;color:#f0f0f0;overflow-x:hidden;position:relative}body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 30%, rgba(41, 103, 178, 0.15) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(178, 41, 123, 0.15) 0%, transparent 50%);pointer-events:none;z-index:-1}body.light{background:#f5f7fa;color:#222}body.light::before{background:radial-gradient(circle at 20% 30%, rgba(100, 200, 255, 0.1) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(255, 150, 100, 0.1) 0%, transparent 50%)}#layout{position:relative;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}main.container{background:rgba(15, 23, 42, 0.95);max-width:420px;width:100%;border-radius:20px;box-shadow:0 12px 30px rgba(8, 12, 26, 0.8);padding:30px;display:flex;flex-direction:column;gap:24px;color:#f0f0f0;text-align:center;z-index:10;user-select:none;min-height:500px;position:relative;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid rgba(92, 184, 92, 0.1);transform:translateY(0);transition:transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), box-shadow 0.4s ease}body.light main.container{background:rgba(255, 255, 255, 0.95);box-shadow:0 12px 30px rgba(0, 0, 0, 0.15);color:#333;border:1px solid rgba(76, 174, 76, 0.2)}.progress-bar{width:100%;height:8px;background:rgba(92, 184, 92, 0.2);border-radius:10px;overflow:hidden;position:relative;margin-bottom:16px;box-shadow:inset 0 0 10px rgba(0, 0, 0, 0.5)}.progress{height:100%;background:linear-gradient(90deg, #5cb85c, #4fd1c5);width:0%;transition:width 0.6s ease;box-shadow:0 0 15px #5cb85caa;position:relative;overflow:hidden}.progress::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);animation:progressShine 2.5s infinite}h1,h2{margin:0;font-weight:700;color:#a3cef1;text-shadow:0 2px 4px rgba(0, 0, 0, 0.3)}body.light h1, body.light h2{color:#286090;text-shadow:none}h1{font-size:2rem;letter-spacing:1.2px;margin-bottom:8px;background:linear-gradient(90deg, #a3cef1, #4fd1c5);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;animation:textShimmer 8s infinite alternate}h2{font-size:1.5rem;margin-bottom:12px}p{font-size:1.05rem;line-height:1.5;color:#cbd5e1;text-shadow:0 1px 2px rgba(0, 0, 0, 0.3);margin-bottom:12px;word-wrap:break-word;white-space:pre-wrap}body.light p{color:#555}.button-group{display:flex;flex-direction:column;gap:16px;margin-top:15px}button.btn{background:linear-gradient(135deg, #5cb85c, #4fd1c5);border:none;padding:14px 20px;font-size:1.05rem;font-weight:600;border-radius:12px;color:white;cursor:pointer;transition:all 0.3s ease;box-shadow:0 6px 12px rgba(76, 174, 76, 0.5);user-select:none;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;border:1px solid rgba(255, 255, 255, 0.1);transform:translateY(0);will-change:transform}button.btn::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);transform:translateX(-100%);transition:transform 0.6s ease}button.btn:hover,button.btn:focus{background:linear-gradient(135deg, #4cae4c, #38b2ac);box-shadow:0 8px 16px rgba(76, 174, 76, 0.7);transform:translateY(-2px)}button.btn:hover::before{transform:translateX(100%)}button.btn:active{transform:translateY(1px);box-shadow:0 4px 8px rgba(76, 174, 76, 0.5)}button.btn:disabled{background:#555a55;cursor:not-allowed;box-shadow:none;transform:none}.page{display:none;flex-direction:column;gap:16px;opacity:0;transform:translateY(10px);transition:opacity 0.5s ease, transform 0.5s ease;position:absolute;top:30px;left:30px;right:30px;bottom:30px}.page.active{display:flex;opacity:1;transform:translateY(0)}.dialog-box{background:rgba(0, 0, 0, 0.5);border-radius:14px;padding:18px 22px;color:#e0e0e0;text-align:left;box-shadow:0 6px 16px rgba(0, 0, 0, 0.6);position:relative;margin-bottom:16px;max-width:100%;margin-left:auto;margin-right:auto;white-space:pre-wrap;border:1px solid rgba(92, 184, 92, 0.1);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);transform-style:preserve-3d}body.light .dialog-box{background:rgba(255, 255, 255, 0.9);color:#444;box-shadow:0 6px 16px rgba(0, 0, 0, 0.1)}.dialog-box::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg, rgba(92, 184, 92, 0.1), transparent);border-radius:14px;pointer-events:none}.dialog-character{display:flex;align-items:center;gap:12px;margin-bottom:16px;justify-content:center}.avatar{width:52px;height:52px;border-radius:50%;background-size:cover;background-position:center;border:2px solid #5cb85c;flex-shrink:0;box-shadow:0 4px 8px rgba(0, 0, 0, 0.3);transition:transform 0.3s ease}.avatar:hover{transform:scale(1.1) rotate(5deg)}#sidebar{position:fixed;top:60px;right:20px;width:340px;max-width:85vw;max-height:80vh;background:rgba(15, 23, 42, 0.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);box-shadow:0 0 30px rgba(0, 0, 0, 0.9);overflow-y:auto;color:#a3cef1;font-size:0.95rem;padding:25px 20px 20px 20px;user-select:text;z-index:50;border-radius:16px;transform:translateX(120%);transition:transform 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;visibility:hidden;opacity:0;border:1px solid rgba(92, 184, 92, 0.1)}body.light #sidebar{background:rgba(255, 255, 255, 0.95);color:#286090;box-shadow:0 0 30px rgba(0, 0, 0, 0.2)}#sidebar.active{transform:translateX(0);visibility:visible;opacity:1}#sidebar h3{margin-top:0;color:#5cb85c;font-weight:700;font-size:1.4rem;text-align:center;margin-bottom:20px;user-select:text}#sidebar section{margin-bottom:28px;user-select:text}#sidebar h4{margin-bottom:10px;font-weight:700;border-bottom:1px solid rgba(92, 184, 92, 0.5);padding-bottom:6px;user-select:text}#sidebar ul{list-style:none;padding-left:0;max-height:140px;overflow-y:auto;margin:0;user-select:text}#sidebar ul li{margin-bottom:8px;border-bottom:1px solid rgba(92, 184, 92, 0.3);padding-bottom:6px;color:#c0d9d9;word-break:break-word;user-select:text;transition:all 0.3s ease;padding-left:8px}body.light #sidebar ul li{color:#666}#sidebar ul li:hover{transform:translateX(5px);color:#5cb85c}#sidebar ul li::before{content:'•';color:#5cb85c;margin-right:8px}#theme-toggle{position:fixed;top:20px;left:20px;background:linear-gradient(135deg, #5cb85c, #4fd1c5);border:none;border-radius:25px;cursor:pointer;width:100px;height:40px;color:white;font-weight:700;box-shadow:0 6px 12px rgba(76, 174, 76, 0.5);z-index:60;user-select:none;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;gap:8px;overflow:hidden;border:1px solid rgba(255, 255, 255, 0.1)}#theme-toggle:hover,#theme-toggle:focus{background:linear-gradient(135deg, #4cae4c, #38b2ac);box-shadow:0 8px 16px rgba(76, 174, 76, 0.7);transform:translateY(-2px)}#theme-toggle:active{transform:translateY(1px)}#theme-toggle i{font-size:1.1rem}#sidebar-toggle{position:fixed;top:20px;right:20px;background:linear-gradient(135deg, #5cb85c, #4fd1c5);border:none;border-radius:50%;width:48px;height:48px;color:white;font-size:24px;cursor:pointer;box-shadow:0 6px 12px rgba(76, 174, 76, 0.5);z-index:60;user-select:none;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center}#sidebar-toggle:hover,#sidebar-toggle:focus{background:linear-gradient(135deg, #4cae4c, #38b2ac);box-shadow:0 8px 16px rgba(76, 174, 76, 0.7);transform:translateY(-2px) rotate(90deg)}#sidebar-toggle:active{transform:translateY(1px) rotate(90deg)}.typing-cursor{display:inline-block;width:8px;height:1.2em;background-color:#5cb85c;margin-left:4px;animation:blink 1s infinite;vertical-align:middle;transform:translateY(2px)}@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}@keyframes progressShine{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}@keyframes textShimmer{0%{background-position:0% 50%}100%{background-position:100% 50%}}@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}@media (max-width:768px){main.container{max-width:380px;padding:25px;min-height:480px}h1{font-size:1.8rem}h2{font-size:1.3rem}p{font-size:1rem}#sidebar{width:300px;max-width:85vw;top:70px}#sidebar-toggle{width:44px;height:44px;font-size:22px}#theme-toggle{width:90px;height:38px;font-size:0.9rem}}@media (max-width:480px){#layout{justify-content:flex-start;align-items:flex-start;padding-top:90px;padding-bottom:40px}main.container{max-width:90vw;margin:0 auto;min-height:auto;padding:20px;border-radius:16px}h1{font-size:1.6rem}h2{font-size:1.2rem}p{font-size:0.95rem}.button-group{gap:12px}button.btn{padding:12px 16px;font-size:1rem}#sidebar{top:80px;right:15px;width:90vw;height:50vh;max-height:none;border-radius:14px;font-size:0.9rem;padding:20px 15px}#sidebar-toggle{top:15px;right:15px;width:42px;height:42px;font-size:20px}#theme-toggle{top:15px;left:15px;width:80px;height:36px;font-size:0.85rem}}.floating{animation:float 6s ease-in-out infinite}.pulse{animation:pulse 2s ease-in-out infinite}.shake{animation:shake 0.5s ease-in-out}@keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}.fade-in{animation:fadeIn 0.8s ease-out}.slide-up{animation:slideUp 0.6s ease-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
</style>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body data-scene="page-index" class="dark">
<div id="layout">
    <main class="container">
        <div class="progress-bar">
            <div class="progress"></div>
        </div>

        <section id="page-index" class="page active slide-up">
            <h1>Choose Your Adventure</h1>
            <div class="dialog-box pulse">
                <p id="text-page-index">You are about to begin a mysterious, perilous journey. Your pulse quickens as the chill of the unknown creeps in. Every choice shapes your fate...</p><span class="typing-cursor"></span>
            </div>
            <button class="btn" data-target="page1">
                <i class="fas fa-play" style="margin-right: 8px;"></i> Start Adventure
            </button>
        </section>

        <section id="page1" class="page">
            <h2>The Forest Awakens</h2>
            <div class="dialog-character">
                <div class="avatar floating" style="background-image:url('https://i.pravatar.cc/64?img=12')"></div>
                <div class="dialog-box">
                    <p id="text-page1">You wake up amidst broken branches and damp earth. Fog snakes through the trees like sly fingers. A fork in the bloodied path lies ahead. Choose wisely; death could be lurking.</p><span class="typing-cursor"></span>
                </div>
            </div>
            <div class="button-group">
                <button class="btn" data-target="page2a">
                    <i class="fas fa-water" style="margin-right: 8px;"></i> Follow the sound of rushing water
                </button>
                <button class="btn" data-target="page2b">
                    <i class="fas fa-mountain" style="margin-right: 8px;"></i> Climb the bloodstained hill
                </button>
            </div>
        </section>

        <section id="page2a" class="page">
            <h2>The River Path</h2>
            <div class="dialog-box">
                <p id="text-page2a">The river flows fast and furious. Dead fish float along the murky surface. A rotten boat bobbles near the shore. Will you risk that crooked vessel, or walk the sinister riverbank littered with bones?</p><span class="typing-cursor"></span>
            </div>
            <div class="button-group">
                <button class="btn" data-target="ending1">
                    <i class="fas fa-ship" style="margin-right: 8px;"></i> Take the boat — brave the hellish rapids
                </button>
                <button class="btn" data-target="ending2">
                    <i class="fas fa-walking" style="margin-right: 8px;"></i> Walk the riverbank — menace may lurk in shadows
                </button>
            </div>
        </section>

        <section id="page2b" class="page">
            <h2>Hilltop View</h2>
            <div class="dialog-box">
                <p id="text-page2b">You ascend the hill, smelling the acrid stench of smoke and burnt flesh. The sky darkens. A hidden cave yawns nearby, ominous but possibly a refuge. Which will save you, or doom you further?</p><span class="typing-cursor"></span>
            </div>
            <div class="button-group">
                <button class="btn" data-target="ending3">
                    <i class="fas fa-fire" style="margin-right: 8px;"></i> Head to the smoke — danger or rescue?
                </button>
                <button class="btn" data-target="ending4">
                    <i class="fas fa-cave" style="margin-right: 8px;"></i> Enter the cave — darkness hides secrets… and horrors
                </button>
            </div>
        </section>

        <section id="ending1" class="page">
            <h2>Freedom?</h2>
            <div class="dialog-box">
                <p id="text-ending1">The battered boat freezes mid-rapids; twisted metal bites into your side. Blood mixes with river water as you lose consciousness drifting toward a distant village. You survived... but scars remain.</p><span class="typing-cursor"></span>
            </div>
            <button class="btn" data-target="page-index">
                <i class="fas fa-redo" style="margin-right: 8px;"></i> Play Again
            </button>
        </section>

        <section id="ending2" class="page">
            <h2>The Stranger</h2>
            <div class="dialog-box">
                <p id="text-ending2">Along the riverbank, a grim figure draped in shadows offers you a pact — power at a deadly price. The woods whisper curses as you ponder your fate.</p><span class="typing-cursor"></span>
            </div>
            <button class="btn" data-target="page-index">
                <i class="fas fa-redo" style="margin-right: 8px;"></i> Start Again
            </button>
        </section>

        <section id="ending3" class="page">
            <h2>Captured</h2>
            <div class="dialog-box shake">
                <p id="text-ending3">Smoke reveals a brutal encampment. A snare traps you. Bandits laugh cruelly as shackles bite your wrists. Your screams echo in the dark woods — a haunting dirge.</p><span class="typing-cursor"></span>
            </div>
            <button class="btn" data-target="page-index">
                <i class="fas fa-redo" style="margin-right: 8px;"></i> Try Again
            </button>
        </section>

        <section id="ending4" class="page">
            <h2>Secret Treasure</h2>
            <div class="dialog-box pulse">
                <p id="text-ending4">You delve deep into the cave, finding ancient, bloodstained relics and gold that pulses with uncanny energy. Victory tinged with unease – some treasures demand a price.</p><span class="typing-cursor"></span>
            </div>
            <button class="btn" data-target="page-index">
                <i class="fas fa-redo" style="margin-right: 8px;"></i> Play Again
            </button>
        </section>
    </main>

    <aside id="sidebar">
        <h3>Your Journey</h3>
        <section>
            <h4><i class="fas fa-history" style="margin-right: 8px;"></i> Choice History</h4>
            <ul id="choice-history"></ul>
        </section>
        <section>
            <h4><i class="fas fa-backpack" style="margin-right: 8px;"></i> Inventory</h4>
            <ul id="inventory-list"></ul>
        </section>
        <section>
            <h4><i class="fas fa-trophy" style="margin-right: 8px;"></i> Unlocked Endings</h4>
            <ul id="endings-list"></ul>
        </section>
    </aside>
</div>

<button id="theme-toggle">
    <i class="fas fa-moon"></i> Dark Mode
</button>
<button id="sidebar-toggle">☰</button>
<footer>&copy; 2024 Choose Your Adventure &mdash; Enjoy responsibly.</footer>

<audio id="ambient-player" loop preload="auto"></audio>
<audio id="sfx-player" preload="auto"></audio>
<audio id="transition-sfx" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3"></audio>

<script>
(() => {
    const buttons = document.querySelectorAll('button.btn');
    const pages = document.querySelectorAll('.page');
    const progressBar = document.querySelector('.progress');
    const choiceHistoryElem = document.getElementById('choice-history');
    const inventoryListElem = document.getElementById('inventory-list');
    const endingsListElem = document.getElementById('endings-list');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const themeToggle = document.getElementById('theme-toggle');
    const ambientPlayer = document.getElementById('ambient-player');
    const sfxPlayer = document.getElementById('sfx-player');
    const transitionSfx = document.getElementById('transition-sfx');
    const body = document.body;
    const container = document.querySelector('.container');

    const pageOrder = ['page-index', 'page1', 'page2a', 'page2b', 'ending1', 'ending2', 'ending3', 'ending4'];
    let inventory = [];
    let choiceHistory = [];
    let unlockedEndings = [];
    let typingTimeout = null;
    const SAVE_KEY = 'choose-your-adventure-save';
    let currentPageId = 'page-index';

    // Enhanced typewriter effect with random speed variation
    function typeText(element, text, callback = null) {
        if (typingTimeout) clearTimeout(typingTimeout);
        element.textContent = '';
        let index = 0;
        const cursor = element.nextElementSibling;
        if (cursor) cursor.style.visibility = 'visible';

        function type() {
            if (index < text.length) {
                // Add slight randomness to typing speed for natural feel
                const speed = 20 + Math.random() * 20;
                
                // Occasionally pause at punctuation
                const char = text.charAt(index);
                if (index > 0 && ['.', ',', ';', '!', '?'].includes(char)) {
                    element.textContent += char;
                    index++;
                    typingTimeout = setTimeout(type, 200 + Math.random() * 300);
                } else {
                    element.textContent += char;
                    index++;
                    typingTimeout = setTimeout(type, speed);
                }
            } else if (callback) {
                if (cursor) cursor.style.visibility = 'visible';
                callback();
            }
        }
        type();
    }

    function showPage(id, options = {}) {
        const { skipTyping = false } = options;
        
        // Play transition sound
        playSfx('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3', 0.3);
        
        // Container animation
        container.style.transform = 'translateY(-10px)';
        container.style.boxShadow = '0 15px 35px rgba(8, 12, 26, 0.9)';
        setTimeout(() => {
            container.style.transform = 'translateY(0)';
            container.style.boxShadow = '0 12px 30px rgba(8, 12, 26, 0.8)';
        }, 300);

        pages.forEach(page => {
            if (page.id === id) {
                page.classList.add('active');
                body.dataset.scene = id;
                
                // Add animation class based on page type
                if (id.startsWith('ending')) {
                    page.classList.add('fade-in');
                    setTimeout(() => page.classList.remove('fade-in'), 1000);
                } else {
                    page.classList.add('slide-up');
                    setTimeout(() => page.classList.remove('slide-up'), 1000);
                }
                
                const pElem = page.querySelector('.dialog-box p') || page.querySelector('p');
                if (pElem) {
                    if (!skipTyping) {
                        typeText(pElem, pElem.dataset.fulltext || pElem.textContent);
                    } else {
                        if (typingTimeout) clearTimeout(typingTimeout);
                        pElem.textContent = pElem.dataset.fulltext || pElem.textContent;
                        const cursor = pElem.nextElementSibling;
                        if (cursor) cursor.style.visibility = 'visible';
                    }
                }
                
                playAmbientSoundForScene(id);
                updateProgress(id);
                
                setTimeout(() => {
                    const focusable = page.querySelector('button');
                    if (focusable) focusable.focus();
                }, 550);
            } else {
                page.classList.remove('active');
                const cursor = page.querySelector('.typing-cursor');
                if (cursor) cursor.style.visibility = 'hidden';
            }
        });
        
        currentPageId = id;
        saveProgress();
    }

    function updateProgress(currentId) {
        const idx = pageOrder.indexOf(currentId);
        if (idx === -1) {
            progressBar.style.width = '0%';
        } else {
            progressBar.style.width = ((idx + 1) / pageOrder.length) * 100 + '%';
        }
    }

    function updateTheme(newTheme) {
        if (newTheme === 'light') {
            body.classList.remove('dark');
            body.classList.add('light');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            playSfx('https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3', 0.2);
        } else {
            body.classList.remove('light');
            body.classList.add('dark');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
            playSfx('https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3', 0.2);
        }
        try {
            localStorage.setItem('choose-your-adventure-theme', newTheme);
        } catch {}
    }

    themeToggle.onclick = () => {
        updateTheme(body.classList.contains('dark') ? 'light' : 'dark');
    };

    function playAmbientSoundForScene(sceneId) {
        let soundUrl = '';
        switch(sceneId) {
            case 'page-index': soundUrl = 'https://assets.mixkit.co/sfx/preview/mixkit-calm-wind-in-the-forest-1254.mp3'; break;
            case 'page1': soundUrl = 'https://assets.mixkit.co/sfx/preview/mixkit-forest-ambience-1685.mp3'; break;
            case 'page2a': soundUrl = 'https://assets.mixkit.co/sfx/preview/mixkit-river-water-flowing-1248.mp3'; break;
            case 'page2b': soundUrl = 'https://assets.mixkit.co/sfx/preview/mixkit-wind-in-the-mountains-1252.mp3'; break;
            case 'ending1': soundUrl = 'https://assets.mixkit.co/sfx/preview/mixkit-rain-and-thunder-ambience-2403.mp3'; break;
            case 'ending2': soundUrl = 'https://assets.mixkit.co/sfx/preview/mixkit-dark-ambient-horror-566.mp3'; break;
            case 'ending3': soundUrl = 'https://assets.mixkit.co/sfx/preview/mixkit-suspense-dark-ambience-566.mp3'; break;
            case 'ending4': soundUrl = 'https://assets.mixkit.co/sfx/preview/mixkit-mysterious-cave-ambience-568.mp3'; break;
        }
        if (soundUrl) {
            ambientPlayer.src = soundUrl;
            ambientPlayer.volume = 0.2;
            ambientPlayer.play().catch(()=>{});
        } else {
            ambientPlayer.pause();
            ambientPlayer.src = '';
        }
    }

    function playSfx(url, volume = 0.5) {
        sfxPlayer.src = url;
        sfxPlayer.volume = volume;
        sfxPlayer.play().catch(() => {});
    }

    function saveProgress() {
        try {
            localStorage.setItem(SAVE_KEY, JSON.stringify({
                currentPage: currentPageId,
                choiceHistory,
                inventory,
                unlockedEndings
            }));
        } catch(e) {}
    }

    function loadProgress() {
        try {
            const saved = localStorage.getItem(SAVE_KEY);
            if (!saved) return false;
            const data = JSON.parse(saved);
            if (!data) return false;
            if (data.choiceHistory) choiceHistory = data.choiceHistory;
            if (data.inventory) inventory = data.inventory;
            if (data.unlockedEndings) unlockedEndings = data.unlockedEndings;
            updateChoiceUI();
            updateInventoryUI();
            updateEndingsUI();
            if (data.currentPage && pageOrder.includes(data.currentPage)) {
                showPage(data.currentPage, { skipTyping:true });
                return true;
            }
            return false;
        } catch(e) {
            return false;
        }
    }

    function addChoice(text, toPage) {
        choiceHistory.push({ choice: text, page: toPage });
        updateChoiceUI();
    }

    function updateChoiceUI() {
        choiceHistoryElem.innerHTML = '';
        if (choiceHistory.length === 0) {
            const li = document.createElement('li');
            li.textContent = '(No choices made yet)';
            choiceHistoryElem.appendChild(li);
        } else {
            choiceHistory.slice().reverse().forEach(c => {
                const li = document.createElement('li');
                li.textContent = c.choice;
                choiceHistoryElem.appendChild(li);
            });
        }
    }

    function addItem(item) {
        if (!inventory.includes(item)) {
            inventory.push(item);
            playSfx('https://assets.mixkit.co/sfx/preview/mixkit-extra-bonus-in-a-video-game-2045.mp3', 0.4);
            updateInventoryUI();
            
            // Item notification animation
            const notification = document.createElement('div');
            notification.innerHTML = `<i class="fas fa-plus-circle"></i> ${item} added to inventory`;
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = 'rgba(92, 184, 92, 0.9)';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '25px';
            notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
            notification.style.zIndex = '100';
            notification.style.animation = 'slideUp 0.5s ease-out, fadeIn 0.5s ease-out';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeIn 0.5s ease-out reverse';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    }

    function updateInventoryUI() {
        inventoryListElem.innerHTML = '';
        if (inventory.length === 0) {
            const li = document.createElement('li');
            li.textContent = '(No items collected)';
            inventoryListElem.appendChild(li);
        } else {
            inventory.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                inventoryListElem.appendChild(li);
            });
        }
    }

    function unlockEnding(id, title) {
        if (!unlockedEndings.find(e => e.id === id)) {
            unlockedEndings.push({ id, title });
            playSfx('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3', 0.6);
            updateEndingsUI();
            
            // Ending unlocked notification
            const notification = document.createElement('div');
            notification.innerHTML = `<i class="fas fa-trophy"></i> Ending Unlocked: ${title}`;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = 'rgba(76, 174, 76, 0.9)';
            notification.style.color = 'white';
            notification.style.padding = '12px 24px';
            notification.style.borderRadius = '25px';
            notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
            notification.style.zIndex = '100';
            notification.style.animation = 'slideUp 0.5s ease-out, fadeIn 0.5s ease-out';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeIn 0.5s ease-out reverse';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }
    }

    function updateEndingsUI() {
        endingsListElem.innerHTML = '';
        if (unlockedEndings.length === 0) {
            const li = document.createElement('li');
            li.textContent = '(No endings unlocked)';
            endingsListElem.appendChild(li);
        } else {
            unlockedEndings.slice().reverse().forEach(e => {
                const li = document.createElement('li');
                li.textContent = e.title;
                endingsListElem.appendChild(li);
            });
        }
    }

    function prepareTexts() {
        pages.forEach(page => {
            const p = page.querySelector('.dialog-box p') || page.querySelector('p');
            if (p) p.dataset.fulltext = p.textContent;
        });
    }

    sidebarToggle.addEventListener('click', () => {
        const isActive = sidebar.classList.contains('active');
        playSfx('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3', 0.3);
        if (isActive) {
            sidebar.classList.remove('active');
            sidebarToggle.innerHTML = '☰';
        } else {
            sidebar.classList.add('active');
            sidebarToggle.innerHTML = '✕';
            sidebar.focus();
        }
    });

    // Close sidebar when clicking outside
    document.addEventListener('click', (e) => {
        if (sidebar.classList.contains('active') && 
            !sidebar.contains(e.target) && 
            e.target !== sidebarToggle) {
            sidebar.classList.remove('active');
            sidebarToggle.innerHTML = '☰';
        }
    });

    buttons.forEach(button => {
        button.addEventListener('click', () => {
            const target = button.getAttribute('data-target');
            if (!target) return;

            playSfx('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3', 0.4);
            
            // Button press animation
            button.classList.add('pulse');
            setTimeout(() => button.classList.remove('pulse'), 1000);
            
            buttons.forEach(b => b.disabled = true);
            setTimeout(() => buttons.forEach(b => b.disabled = false), 700);

            if (!(currentPageId === 'page-index' && target === 'page-index')) {
                if (currentPageId !== target) addChoice(button.textContent.trim(), target);
            }

            if (currentPageId === 'page2a' && target === 'ending1') addItem('Rusty Boat');
            if (currentPageId === 'page2b' && target === 'ending4') addItem('Ancient Map');

            if (target.startsWith('ending')) {
                const endingTitle = document.getElementById(target).querySelector('h2').textContent;
                unlockEnding(target, endingTitle);
            }

            showPage(target);
        });
    });

    function init() {
        prepareTexts();
        updateChoiceUI();
        updateInventoryUI();
        updateEndingsUI();
        const loaded = loadProgress();
        if (!loaded) showPage('page-index', { skipTyping: true });
    }

    const savedTheme = localStorage.getItem('choose-your-adventure-theme');
    updateTheme(savedTheme || 'dark');
    window.addEventListener('beforeunload', saveProgress);
    init();
})();
</script>
</body>
</html>
